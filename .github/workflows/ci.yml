name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      # ------------------------
      # Start MongoDB as replica set (Docker)
      # ------------------------
      - name: Start Mongo (replica set)
        run: |
          docker run -d --name mongo \
            -p 27017:27017 \
            mongo:7 mongod --replSet rs0 --bind_ip_all

      - name: Init Mongo replica set
        run: |
          for i in {1..30}; do
            docker exec mongo mongosh --quiet --eval "db.runCommand({ ping: 1 })" && break
            sleep 1
          done
          docker exec mongo mongosh --eval "rs.initiate({_id:'rs0',members:[{_id:0,host:'127.0.0.1:27017'}]})" || true

      # ------------------------
      # Backend: install + tests
      # ------------------------
      - name: Install backend deps
        working-directory: backend
        run: npm install

      - name: Create backend test env file
        working-directory: backend
        run: |
          cat > .env.test << 'EOF'
          MONGO_URI=mongodb://127.0.0.1:27017/ecom_test?replicaSet=rs0
          JWT_SECRET=testsecret
          SHIPPING_FEE_USD=5
          PAYMENT_PROVIDER=mock
          FRONTEND_ORIGIN=http://localhost:3000
          EOF

      - name: Run backend tests (Jest + Supertest)
        working-directory: backend
        run: npm test

      # ------------------------
      # Frontend: install
      # ------------------------
      - name: Install frontend deps
        working-directory: frontend
        run: npm install

      - name: Create frontend env file
        working-directory: frontend
        run: |
          cat > .env.local << 'EOF'
          NEXT_PUBLIC_API_URL=http://localhost:4000
          EOF

      # ------------------------
      # Start servers (NOHUP) + hard checks (no hanging)
      # ------------------------
      - name: Start backend
        working-directory: backend
        run: |
          nohup node src/index.js > backend.log 2>&1 &
          echo "Backend started"

      - name: Start frontend
        working-directory: frontend
        run: |
          nohup npm run dev -- --port 3000 --hostname 0.0.0.0 > frontend.log 2>&1 &
          echo "Frontend started"

      - name: Wait & verify servers
        run: |
          set -e
          echo "Waiting for backend..."
          for i in {1..40}; do
            if curl -fsS http://localhost:4000/health > /dev/null; then
              echo "Backend OK"
              break
            fi
            sleep 1
          done

          echo "Waiting for frontend..."
          for i in {1..40}; do
            if curl -fsS http://localhost:3000/login > /dev/null; then
              echo "Frontend OK"
              break
            fi
            sleep 1
          done

          # final assert (fail fast with logs)
          curl -fsS http://localhost:4000/health > /dev/null || (echo "Backend not reachable" && exit 1)
          curl -fsS http://localhost:3000/login > /dev/null || (echo "Frontend not reachable" && exit 1)

      # ------------------------
      # Cypress
      # ------------------------
      - name: Run Cypress (headless)
        working-directory: frontend
        run: npx cypress run

      - name: Print logs on failure
        if: failure()
        run: |
          echo "---- BACKEND LOG ----"
          tail -n 200 backend/backend.log || true
          echo "---- FRONTEND LOG ----"
          tail -n 200 frontend/frontend.log || true
          echo "---- MONGO LOG ----"
          docker logs mongo --tail 200 || true