name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      # ---------------------------
      # MongoDB (replica set)
      # ---------------------------
      - name: Start Mongo (replica set)
        run: |
          docker run -d --name mongo -p 27017:27017 mongo:7 mongod --replSet rs0 --bind_ip_all

      - name: Init Mongo replica set
        run: |
          for i in {1..30}; do
            docker exec mongo mongosh --quiet --eval "db.runCommand({ ping: 1 })" && break
            sleep 1
          done

          docker exec mongo mongosh --eval "rs.initiate({_id:'rs0',members:[{_id:0,host:'127.0.0.1:27017'}]})" || true

          for i in {1..30}; do
            docker exec mongo mongosh --quiet --eval "rs.isMaster().ismaster" | grep true && break
            sleep 1
          done

      # ---------------------------
      # Backend: Install + Jest
      # ---------------------------
      - name: Install backend deps
        working-directory: backend
        run: npm install

      - name: Run backend tests (Jest)
        working-directory: backend
        run: |
          export MONGO_URI="mongodb://127.0.0.1:27017/ecom_test?replicaSet=rs0"
          export JWT_SECRET="testsecret"
          export FRONTEND_ORIGIN="http://localhost:3000"
          npm test

      # ---------------------------
      # Frontend: Install
      # ---------------------------
      - name: Install frontend deps
        working-directory: frontend
        run: npm install

      # ---------------------------
      # Start servers
      # ---------------------------
      - name: Start backend
        working-directory: backend
        run: |
          export MONGO_URI="mongodb://127.0.0.1:27017/ecom_test?replicaSet=rs0"
          export JWT_SECRET="testsecret"
          export FRONTEND_ORIGIN="http://localhost:3000"
          node src/index.js > backend.log 2>&1 &
          sleep 3
          tail -n 200 backend.log || true

      - name: Start frontend
        working-directory: frontend
        run: |
          export NEXT_PUBLIC_API_URL="http://localhost:4000"
          npm run dev -- --port 3000 --hostname 0.0.0.0 > frontend.log 2>&1 &
          sleep 5
          tail -n 200 frontend.log || true

      # ---------------------------
      # Health checks
      # ---------------------------
      - name: Verify servers
        run: |
          curl -fsS http://localhost:4000/health
          curl -fsS http://localhost:3000/login

      # ---------------------------
      # Cypress run
      # ---------------------------
      - name: Run Cypress
        working-directory: frontend
        run: npx cypress run

      # ---------------------------
      # Print logs if failed
      # ---------------------------
      - name: Print logs on failure
        if: failure()
        run: |
          echo "---- BACKEND LOG ----"
          tail -n 300 backend/backend.log || true
          echo "---- FRONTEND LOG ----"
          tail -n 300 frontend/frontend.log || true
          echo "---- MONGO LOG ----"
          docker logs mongo --tail 300 || true