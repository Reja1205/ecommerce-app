name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # Checkout code
      # ------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------
      # Setup Node
      # ------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      # ------------------------
      # Start MongoDB as replica set (Docker)
      # ------------------------
      - name: Start Mongo (replica set)
        run: |
          docker run -d --name mongo \
            -p 27017:27017 \
            mongo:7 mongod --replSet rs0 --bind_ip_all

      - name: Init Mongo replica set
        run: |
          for i in {1..30}; do
            docker exec mongo mongosh --quiet --eval "db.runCommand({ ping: 1 })" && break
            sleep 1
          done
          docker exec mongo mongosh --eval "rs.initiate({_id:'rs0',members:[{_id:0,host:'127.0.0.1:27017'}]})" || true
          for i in {1..30}; do
            docker exec mongo mongosh --quiet --eval "rs.isMaster().ismaster" | grep true && break
            sleep 1
          done

      # ------------------------
      # Backend install
      # ------------------------
      - name: Install backend deps
        working-directory: backend
        run: npm install

      # ------------------------
      # Backend test env
      # ------------------------
      - name: Create backend test env file
        working-directory: backend
        run: |
          cat > .env.test << 'EOF'
          MONGO_URI=mongodb://127.0.0.1:27017/ecom_test?replicaSet=rs0
          JWT_SECRET=testsecret
          SHIPPING_FEE_USD=5
          PAYMENT_PROVIDER=mock
          FRONTEND_ORIGIN=http://localhost:3000
          EOF

      # ------------------------
      # Backend tests
      # ------------------------
      - name: Run backend tests (Jest)
        working-directory: backend
        run: npm test

      # ------------------------
      # Frontend install
      # ------------------------
      - name: Install frontend deps
        working-directory: frontend
        run: npm install

      # ------------------------
      # Frontend env
      # ------------------------
      - name: Create frontend env file
        working-directory: frontend
        run: |
          cat > .env.local << 'EOF'
          NEXT_PUBLIC_API_URL=http://localhost:4000
          EOF

      # ------------------------
      # Start backend server (with env)
      # ------------------------
      - name: Start backend
        working-directory: backend
        run: |
          DOTENV_CONFIG_PATH=./.env.test node -r dotenv/config src/index.js > backend.log 2>&1 &
          sleep 3
          echo "---- BACKEND LOG ----"
          tail -n 200 backend.log || true

      # ------------------------
      # Start frontend server
      # ------------------------
      - name: Start frontend
        working-directory: frontend
        run: |
          npm run dev -- --port 3000 --hostname 0.0.0.0 > frontend.log 2>&1 &
          sleep 5
          echo "---- FRONTEND LOG ----"
          tail -n 200 frontend.log || true

      # ------------------------
      # Verify servers (fail fast)
      # ------------------------
      - name: Verify servers
        run: |
          curl -fsS http://localhost:4000/health || (echo "Backend not reachable" && exit 1)
          curl -fsS http://localhost:3000/login || (echo "Frontend not reachable" && exit 1)

      # ------------------------
      # Cypress E2E
      # ------------------------
      - name: Run Cypress (headless)
        working-directory: frontend
        run: npx cypress run

      # ------------------------
      # Logs on failure
      # ------------------------
      - name: Print logs on failure
        if: failure()
        run: |
          echo "---- BACKEND LOG ----"
          tail -n 300 backend/backend.log || true
          echo "---- FRONTEND LOG ----"
          tail -n 300 frontend/frontend.log || true
          echo "---- MONGO LOG ----"
          docker logs mongo --tail 300 || true